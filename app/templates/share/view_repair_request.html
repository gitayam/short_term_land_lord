<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Request: {{ repair_request.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Custom Translation Solution -->
    <script type="text/javascript">
    // Translation dictionary
    const translations = {
        en: {
            language: "Language",
            repair_request: "Repair Request",
            description: "Description",
            property_info: "Property Information",
            service_details: "Service Details",
            location: "Specific Location",
            urgency: "Urgency",
            status: "Current Status",
            due_date: "Due Date",
            scheduled_date: "Scheduled Date",
            attachments: "Attachments",
            contact: "Need to discuss this repair?",
            contact_msg: "Please contact the property management for additional details or to schedule service.",
            expires: "This share link expires on",
            submitted: "Submitted",
            property: "Property",
            address: "Address",
            service_type: "Service Type",
            pending: "Pending",
            in_progress: "In Progress",
            completed: "Completed",
            high: "HIGH",
            medium: "MEDIUM",
            low: "LOW",
            urgent: "URGENT",
            apple_maps: "Apple Maps",
            google_maps: "Google Maps"
        },
        es: {
            language: "Idioma",
            repair_request: "Solicitud de Reparación",
            description: "Descripción",
            property_info: "Información de la Propiedad",
            service_details: "Detalles del Servicio",
            location: "Ubicación Específica",
            urgency: "Urgencia",
            status: "Estado Actual",
            due_date: "Fecha de Vencimiento",
            scheduled_date: "Fecha Programada",
            attachments: "Archivos Adjuntos",
            contact: "¿Necesita discutir esta reparación?",
            contact_msg: "Por favor contacte a la administración de la propiedad para detalles adicionales o para programar el servicio.",
            expires: "Este enlace expira el",
            submitted: "Enviado",
            property: "Propiedad",
            address: "Dirección",
            service_type: "Tipo de Servicio",
            pending: "Pendiente",
            in_progress: "En Progreso",
            completed: "Completado",
            high: "ALTA",
            medium: "MEDIA",
            low: "BAJA",
            urgent: "URGENTE",
            apple_maps: "Apple Maps",
            google_maps: "Google Maps"
        },
        zh: {
            language: "语言",
            repair_request: "维修请求",
            description: "描述",
            property_info: "物业信息",
            service_details: "服务详情",
            location: "具体位置",
            urgency: "紧急程度",
            status: "当前状态",
            due_date: "截止日期",
            scheduled_date: "预定日期",
            attachments: "附件",
            contact: "需要讨论此维修吗？",
            contact_msg: "请联系物业管理以获取更多详情或安排服务。",
            expires: "此分享链接将于以下时间过期",
            submitted: "已提交",
            property: "物业",
            address: "地址",
            service_type: "服务类型",
            pending: "待处理",
            in_progress: "进行中",
            completed: "已完成",
            high: "高",
            medium: "中",
            low: "低",
            urgent: "紧急",
            apple_maps: "苹果地图",
            google_maps: "谷歌地图"
        }
    };
    
    let currentLang = 'en';
    
    function switchLanguage(lang) {
        currentLang = lang;
        
        // Update button states
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-light');
        });
        
        const activeBtn = document.querySelector(`[onclick="switchLanguage('${lang}')"]`);
        if (activeBtn) {
            activeBtn.classList.remove('btn-light');
            activeBtn.classList.add('btn-primary');
        }
        
        // Apply translations
        applyTranslations(lang);
        
        // Save preference
        localStorage.setItem('preferredLanguage', lang);
    }
    
    function applyTranslations(lang) {
        const trans = translations[lang] || translations.en;
        
        // Translate elements with data-translate attribute
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            if (trans[key]) {
                element.textContent = trans[key];
            }
        });
        
        // Translate status badges dynamically
        document.querySelectorAll('.status-badge').forEach(badge => {
            const text = badge.textContent.trim().toLowerCase().replace(/\s+/g, '_');
            if (trans[text]) {
                badge.textContent = trans[text];
            }
        });
        
        // Translate priority badges dynamically
        document.querySelectorAll('.priority-badge').forEach(badge => {
            const text = badge.textContent.trim().toLowerCase();
            if (trans[text]) {
                badge.textContent = trans[text];
            }
        });
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        // Hide Google Translate element since it's not working
        const googleElement = document.getElementById('google_translate_element');
        if (googleElement) {
            googleElement.style.display = 'none';
        }
        
        // Show fallback selector
        const fallback = document.getElementById('fallback-language-selector');
        if (fallback) {
            fallback.style.display = 'block';
        }
        
        // Load saved language preference
        const savedLang = localStorage.getItem('preferredLanguage') || 'en';
        if (savedLang !== 'en') {
            switchLanguage(savedLang);
        }
    });
    </script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .share-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .share-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .share-header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem;
        }
        .priority-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .priority-urgent {
            background: #dc2626;
            color: white;
        }
        .priority-high {
            background: #f59e0b;
            color: white;
        }
        .priority-medium {
            background: #3b82f6;
            color: white;
        }
        .priority-low {
            background: #10b981;
            color: white;
        }
        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-in-progress {
            background: #dbeafe;
            color: #1e40af;
        }
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        .info-row {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #6b7280;
            width: 150px;
            flex-shrink: 0;
        }
        .info-value {
            color: #111827;
            flex: 1;
        }
        .share-footer {
            background: #f9fafb;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
        }
        .share-meta {
            background: #fef3c7;
            padding: 1rem;
            margin: 1rem 2rem;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #92400e;
        }
        .attachment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .attachment-item {
            aspect-ratio: 1;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            overflow: hidden;
        }
        .attachment-item:hover {
            transform: scale(1.05);
        }
        .attachment-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Translation and Map Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .map-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .map-btn-apple {
            background: linear-gradient(135deg, #007AFF, #005ACF);
            color: white;
        }
        
        .map-btn-apple:hover {
            background: linear-gradient(135deg, #0056D6, #004BB8);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .map-btn-google {
            background: linear-gradient(135deg, #4285F4, #3367D6);
            color: white;
        }
        
        .map-btn-google:hover {
            background: linear-gradient(135deg, #3367D6, #2C5ACB);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .translate-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .translate-label {
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* Custom Google Translate styling */
        #google_translate_element {
            margin: 0;
            position: relative;
            z-index: 10000;
            display: inline-block;
        }
        
        #google_translate_element select,
        #google_translate_element .goog-te-combo {
            background: white !important;
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.875rem !important;
            color: #333 !important;
            position: relative;
            z-index: 10000;
            cursor: pointer !important;
            min-width: 120px;
        }
        
        /* Fallback language selector styling */
        #fallback-language-selector .btn-group {
            display: inline-flex;
            border-radius: 6px;
            overflow: hidden;
        }
        
        #fallback-language-selector .btn {
            border-radius: 0;
            border: none;
            background: white;
            color: #333;
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            transition: all 0.2s;
        }
        
        #fallback-language-selector .btn:hover {
            background: #f0f0f0;
        }
        
        #fallback-language-selector .btn:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }
        
        #fallback-language-selector .btn:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        
        .goog-te-banner-frame {
            display: none !important;
        }
        
        .goog-te-menu-frame {
            max-height: 400px !important;
            z-index: 99999 !important;
        }
        
        /* Fix Google Translate dropdown menu */
        .goog-te-menu2 {
            z-index: 99999 !important;
            position: absolute !important;
        }
        
        .goog-te-menu2-item {
            z-index: 99999 !important;
        }
        
        /* Ensure translate container doesn't clip the dropdown */
        .translate-container {
            overflow: visible !important;
            z-index: 9999;
        }
        
        .action-buttons {
            overflow: visible !important;
            z-index: 9999;
        }
        
        .share-header {
            overflow: visible !important;
            position: relative;
            z-index: 100;
        }
        
        /* Full address styling */
        .full-address {
            font-family: monospace;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
            margin-bottom: 0.5rem;
        }
        
        .address-actions {
            margin-top: 0.75rem;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 576px) {
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .translate-container {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .map-btn {
                justify-content: center;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="share-container">
        <div class="share-card">
            <!-- Header -->
            <div class="share-header">
                <!-- Translation and Action Bar -->
                <div class="action-buttons mb-3">
                    <div class="translate-container">
                        <span class="translate-label">
                            <i class="bi bi-translate me-1"></i>
                            <span data-translate="language">Language:</span>
                        </span>
                        <div id="google_translate_element"></div>
                        
                        <!-- Fallback language selector (hidden by default) -->
                        <div id="fallback-language-selector" style="display: none;">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-primary lang-btn" onclick="switchLanguage('en')">
                                    English
                                </button>
                                <button type="button" class="btn btn-sm btn-light lang-btn" onclick="switchLanguage('es')">
                                    Español
                                </button>
                                <button type="button" class="btn btn-sm btn-light lang-btn" onclick="switchLanguage('zh')">
                                    中文
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-tools me-2"></i>
                        <span data-translate="repair_request">Repair Request</span>
                    </h1>
                    <span class="priority-badge priority-{{ repair_request.priority|lower }}">
                        {{ repair_request.priority }}
                    </span>
                </div>
                <h2 class="h4 mb-2">{{ repair_request.title }}</h2>
                <div class="d-flex align-items-center gap-3 text-white-50">
                    <span>
                        <i class="bi bi-calendar me-1"></i>
                        <span data-translate="submitted">Submitted</span> {{ repair_request.created_at.strftime('%B %d, %Y') }}
                    </span>
                    <span class="status-badge status-{{ repair_request.status|lower|replace('_', '-') }}">
                        {{ repair_request.status|replace('_', ' ')|title }}
                    </span>
                </div>
            </div>

            <!-- Share Notice -->
            {% if share.expires_at %}
            <div class="share-meta">
                <i class="bi bi-info-circle me-1"></i>
                <span data-translate="expires">This share link expires on</span> {{ share.expires_at.strftime('%B %d, %Y at %I:%M %p') }}
            </div>
            {% endif %}

            <!-- Main Content -->
            <div class="p-4">
                <!-- Description -->
                <div class="mb-4">
                    <h5 class="text-muted mb-3">
                        <i class="bi bi-card-text me-2"></i>
                        <span data-translate="description">Description</span>
                    </h5>
                    <div class="bg-light p-3 rounded">
                        {{ repair_request.description|nl2br|safe }}
                    </div>
                </div>

                <!-- Property Information -->
                <div class="mb-4">
                    <h5 class="text-muted mb-3">
                        <i class="bi bi-house me-2"></i>
                        <span data-translate="property_info">Property Information</span>
                    </h5>
                    <div class="bg-white border rounded p-3">
                        {% if repair_request.property %}
                        <div class="info-row">
                            <span class="info-label" data-translate="property">Property:</span>
                            <span class="info-value">{{ repair_request.property.name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label" data-translate="address">Address:</span>
                            <div class="info-value">
                                <div class="full-address">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    {{ repair_request.property.get_full_address_for_maps() }}
                                </div>
                                <div class="address-actions">
                                    {% if repair_request.property.get_maps_url_apple() %}
                                    <a href="{{ repair_request.property.get_maps_url_apple() }}" 
                                       target="_blank" 
                                       class="map-btn map-btn-apple">
                                        <i class="bi bi-apple"></i>
                                        <span data-translate="apple_maps">Apple Maps</span>
                                    </a>
                                    {% endif %}
                                    {% if repair_request.property.get_maps_url_google() %}
                                    <a href="{{ repair_request.property.get_maps_url_google() }}" 
                                       target="_blank" 
                                       class="map-btn map-btn-google">
                                        <i class="bi bi-geo-alt"></i>
                                        <span data-translate="google_maps">Google Maps</span>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% elif repair_request.task_properties %}
                        {% set first_property = repair_request.task_properties[0] %}
                        <div class="info-row">
                            <span class="info-label">Property:</span>
                            <span class="info-value">{{ first_property.property.name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label" data-translate="address">Address:</span>
                            <div class="info-value">
                                <div class="full-address">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    {{ first_property.property.get_full_address_for_maps() }}
                                </div>
                                <div class="address-actions">
                                    {% if first_property.property.get_maps_url_apple() %}
                                    <a href="{{ first_property.property.get_maps_url_apple() }}" 
                                       target="_blank" 
                                       class="map-btn map-btn-apple">
                                        <i class="bi bi-apple"></i>
                                        <span data-translate="apple_maps">Apple Maps</span>
                                    </a>
                                    {% endif %}
                                    {% if first_property.property.get_maps_url_google() %}
                                    <a href="{{ first_property.property.get_maps_url_google() }}" 
                                       target="_blank" 
                                       class="map-btn map-btn-google">
                                        <i class="bi bi-geo-alt"></i>
                                        <span data-translate="google_maps">Google Maps</span>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if repair_request.location %}
                        <div class="info-row">
                            <span class="info-label" data-translate="location">Specific Location:</span>
                            <span class="info-value">{{ repair_request.location }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Service Details -->
                <div class="mb-4">
                    <h5 class="text-muted mb-3">
                        <i class="bi bi-wrench me-2"></i>
                        <span data-translate="service_details">Service Details</span>
                    </h5>
                    <div class="bg-white border rounded p-3">
                        {% if repair_request.service_type %}
                        <div class="info-row">
                            <span class="info-label" data-translate="service_type">Service Type:</span>
                            <span class="info-value">{{ repair_request.service_type|replace('_', ' ')|title }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span class="info-label" data-translate="urgency">Urgency:</span>
                            <span class="info-value">
                                <span class="priority-badge priority-{{ repair_request.priority.value|lower if repair_request.priority.value else repair_request.priority|lower }}">
                                    {{ repair_request.priority.value|title if repair_request.priority.value else repair_request.priority|title }}
                                </span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label" data-translate="status">Current Status:</span>
                            <span class="info-value">
                                <span class="status-badge status-{{ repair_request.status.value|lower|replace('_', '-') if repair_request.status.value else repair_request.status|lower|replace('_', '-') }}">
                                    {{ repair_request.status.value|replace('_', ' ')|title if repair_request.status.value else repair_request.status|replace('_', ' ')|title }}
                                </span>
                            </span>
                        </div>
                        {% if repair_request.scheduled_date %}
                        <div class="info-row">
                            <span class="info-label" data-translate="scheduled_date">Scheduled Date:</span>
                            <span class="info-value">
                                {{ repair_request.scheduled_date.strftime('%B %d, %Y') }}
                            </span>
                        </div>
                        {% elif repair_request.due_date %}
                        <div class="info-row">
                            <span class="info-label" data-translate="due_date">Due Date:</span>
                            <span class="info-value">
                                {{ repair_request.due_date.strftime('%B %d, %Y') }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Attachments/Media -->
                {% set media_items = repair_request.media if repair_request.media else repair_request.task_media if repair_request.task_media else [] %}
                {% if media_items %}
                <div class="mb-4">
                    <h5 class="text-muted mb-3">
                        <i class="bi bi-paperclip me-2"></i>
                        <span data-translate="attachments">Attachments</span>
                    </h5>
                    <div class="attachment-grid">
                        {% for media in media_items %}
                        <div class="attachment-item" onclick="window.open('{{ media.get_url() if media.get_url else media.file_path }}', '_blank')">
                            {% if media.media_type == 'image' or (media.media_type and media.media_type.value == 'image') %}
                                <img src="{{ media.get_url() if media.get_url else media.file_path }}" alt="Attachment">
                            {% else %}
                                <i class="bi bi-file-earmark fs-1 text-muted"></i>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Contact Information (Limited) -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong data-translate="contact">Need to discuss this repair?</strong>
                    <br>
                    <span data-translate="contact_msg">Please contact the property management for additional details or to schedule service.</span>
                </div>
            </div>

            <!-- Footer -->
            <div class="share-footer">
                <p class="mb-1">
                    <strong>Alfaren Property Management</strong>
                </p>
                <p class="mb-0">
                    This shared link was created for temporary access. 
                    {% if share.notes %}
                        <br><em>{{ share.notes }}</em>
                    {% endif %}
                </p>
                <p class="mt-2 mb-0 text-muted small">
                    View count: {{ share.view_count }} | 
                    Share ID: {{ share.share_token[:8] }}...
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>