{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0">Invoices</h1>
                <p class="text-secondary">Manage your property invoices and billing</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('invoicing.financial_reports') }}" class="app-btn app-btn-ghost">
                    <i class="bi bi-bar-chart"></i> Financial Reports
                </a>
                <a href="{{ url_for('invoicing.generate_from_tasks') }}" class="app-btn app-btn-ghost">
                    <i class="bi bi-magic"></i> Generate from Tasks
                </a>
                <a href="{{ url_for('invoicing.create_invoice') }}" class="app-btn app-btn-primary">
                    <i class="bi bi-plus-circle"></i> Create Invoice
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Search and Export -->
<div class="app-card mb-4">
    <div class="app-card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="app-form-group mb-0">
                    <input type="text" id="invoiceSearch" class="app-form-control" placeholder="Quick search by invoice # or property...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-flex gap-2 justify-content-end">
                    <button class="app-btn app-btn-secondary app-btn-sm" id="exportCSV">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
                    </button>
                    <button class="app-btn app-btn-secondary app-btn-sm" id="exportPDF">
                        <i class="bi bi-file-earmark-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="app-card mb-6">
        <div class="app-card-header">
            <h3>Filter Invoices</h3>
        </div>
        <div class="app-card-body">
            <form method="get" action="{{ url_for('invoicing.invoices') }}">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            {{ form.property.label }}
                            {{ form.property(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            {{ form.status.label }}
                            {{ form.status(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            {{ form.date_from.label }}
                            {{ form.date_from(class="form-control", type="date") }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            {{ form.date_to.label }}
                            {{ form.date_to(class="form-control", type="date") }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="form-check mt-2">
                                {{ form.is_paid(class="form-check-input") }}
                                {{ form.is_paid.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="d-block">
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- My Invoices Filter for Staff -->
    {% if not (current_user.is_admin or current_user.is_property_owner or current_user.is_property_manager) %}
    <div class="mb-3">
        <form method="get" action="{{ url_for('invoicing.invoices') }}" class="form-inline">
            <input type="hidden" name="my_invoices" value="{{ 'n' if my_invoices_only else 'y' }}">
            <button type="submit" class="btn btn-outline-primary btn-sm">
                {% if my_invoices_only %}Show All Invoices{% else %}Show My Invoices Only{% endif %}
            </button>
            {% if my_invoices_only %}
            <span class="ml-2 text-info">Showing only invoices you contributed to.</span>
            {% endif %}
        </form>
    </div>
    {% endif %}

    <!-- Status Color Legend -->
<div class="mb-4">
    <div class="d-flex gap-3 flex-wrap align-items-center">
        <span class="app-badge app-badge-secondary" data-bs-toggle="tooltip" title="Draft">Draft</span>
        <span class="app-badge app-badge-primary" data-bs-toggle="tooltip" title="Sent">Sent</span>
        <span class="app-badge app-badge-success" data-bs-toggle="tooltip" title="Paid">Paid</span>
        <span class="app-badge app-badge-danger" data-bs-toggle="tooltip" title="Overdue">Overdue</span>
        <span class="app-badge" style="background: var(--bg-quaternary); color: var(--text-primary);" data-bs-toggle="tooltip" title="Cancelled">Cancelled</span>
        <span class="ms-3 text-muted small">Status Color Legend</span>
    </div>
</div>

{% if invoices %}
<div class="app-table-responsive">
    <div class="app-table-container">
        <table class="app-table" id="invoiceTable">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Property</th>
                    <th>Date Range</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Due Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td data-label="Invoice #">{{ invoice.invoice_number }}</td>
                    <td data-label="Property">{{ invoice.property.name }}</td>
                    <td data-label="Date Range">
                        {% if invoice.date_from and invoice.date_to %}
                        {{ invoice.date_from.strftime('%b %d') }} - {{ invoice.date_to.strftime('%b %d, %Y') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td data-label="Status">
                        {% if invoice.status.value == 'draft' %}
                        <span class="app-badge app-badge-secondary" data-bs-toggle="tooltip" title="Draft">Draft</span>
                        {% elif invoice.status.value == 'sent' %}
                        <span class="app-badge app-badge-primary" data-bs-toggle="tooltip" title="Sent">Sent</span>
                        {% elif invoice.status.value == 'paid' %}
                        <span class="app-badge app-badge-success" data-bs-toggle="tooltip" title="Paid">Paid</span>
                        {% elif invoice.status.value == 'overdue' %}
                        <span class="app-badge app-badge-danger" data-bs-toggle="tooltip" title="Overdue">Overdue</span>
                        {% elif invoice.status.value == 'cancelled' %}
                        <span class="app-badge" style="background: var(--bg-quaternary); color: var(--text-primary);" data-bs-toggle="tooltip" title="Cancelled">Cancelled</span>
                        {% endif %}
                    </td>
                    <td data-label="Total">${{ "%.2f"|format(invoice.total) }}</td>
                    <td data-label="Due Date">
                        {% if invoice.due_date %}
                        {{ invoice.due_date.strftime('%b %d, %Y') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td data-label="Actions">
                        <div class="d-flex gap-1">
                            <a href="{{ url_for('invoicing.view_invoice', id=invoice.id) }}" class="app-btn app-btn-primary app-btn-sm">
                                <i class="bi bi-eye"></i> View
                            </a>
                            {% if invoice.status.value == 'draft' %}
                            <a href="{{ url_for('invoicing.edit_invoice', id=invoice.id) }}" class="app-btn app-btn-secondary app-btn-sm">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination Controls -->
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Invoice pagination">
            <ul class="pagination" id="invoicePagination"></ul>
        </nav>
    </div>
</div>
{% else %}
<div class="app-alert app-alert-info">
    <i class="bi bi-info-circle"></i>
    <div>
        <p class="mb-0">No invoices found. Use the "Create New Invoice" button to create your first invoice.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Enable tooltips
$(function () {
  $('[data-toggle="tooltip"]').tooltip();
});
// Quick search filter
$('#invoiceSearch').on('keyup', function() {
    var value = $(this).val().toLowerCase();
    $("#invoiceTable tbody tr").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
    });
});
// Export CSV
$('#exportCSV').on('click', function() {
    // Simple CSV export for visible rows
    var csv = [];
    $('#invoiceTable tr:has(td)').each(function() {
        var row = [];
        $(this).find('td').each(function() {
            row.push($(this).text().trim());
        });
        csv.push(row.join(","));
    });
    var csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
    var downloadLink = document.createElement("a");
    downloadLink.download = "invoices.csv";
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);
    downloadLink.click();
});
// Export PDF (simple print dialog for now)
$('#exportPDF').on('click', function() {
    window.print();
});
// Pagination (client-side for now)
$(document).ready(function() {
    var rowsPerPage = 10;
    var rows = $('#invoiceTable tbody tr');
    var rowsCount = rows.length;
    var pageCount = Math.ceil(rowsCount / rowsPerPage);
    var numbers = $('#invoicePagination');
    for (var i = 0; i < pageCount; i++) {
        numbers.append('<li class="page-item"><a href="#" class="page-link">'+ (i+1) +'</a></li>');
    }
    $('#invoiceTable tbody tr').hide();
    $('#invoiceTable tbody tr').slice(0, rowsPerPage).show();
    $('#invoicePagination li:first').addClass('active');
    $('#invoicePagination li').click(function(e){
        e.preventDefault();
        $('#invoicePagination li').removeClass('active');
        $(this).addClass('active');
        var currPage = $(this).index();
        var startItem = currPage * rowsPerPage;
        var endItem = startItem + rowsPerPage;
        $('#invoiceTable tbody tr').hide().slice(startItem, endItem).show();
    });
});
</script>
{% endblock %}