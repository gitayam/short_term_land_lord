{% extends "base.html" %}

{% block styles %}
{{ super() }}
{# Use FullCalendar v6 with scheduler #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css">

<style>
    /* CSS Custom Properties - Design System */
    :root {
        /* Spacing Scale */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-2xl: 48px;
        
        /* Border Radius Scale */
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-2xl: 24px;
        
        /* Shadow Scale */
        --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
        --shadow-lg: 0 10px 15px rgba(0,0,0,0.10), 0 4px 6px rgba(0,0,0,0.05);
        --shadow-xl: 0 20px 25px rgba(0,0,0,0.15), 0 8px 10px rgba(0,0,0,0.04);
        
        /* Platform Colors - Accessible */
        --airbnb-primary: #FF5A5F;
        --airbnb-accessible: #E31E23;
        --vrbo-primary: #3D67FF;
        --vrbo-accessible: #1976D2;
        --booking-primary: #003580;
        --booking-accessible: #0D47A1;
        --direct-primary: #34C759;
        --direct-accessible: #2E7D32;
        
        /* Status Colors */
        --status-confirmed: #10B981;
        --status-pending: #F59E0B;
        --status-cancelled: #EF4444;
        --status-blocked: #6B7280;
        
        /* Neutral Colors */
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
        
        /* Background & Surface */
        --bg-primary: #FFFFFF;
        --bg-secondary: var(--gray-50);
        --bg-tertiary: var(--gray-100);
        
        /* Typography */
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        
        /* Animation */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        color: var(--gray-800);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
        line-height: 1.6;
    }

    .calendar-container {
        margin-top: var(--spacing-lg);
        background: var(--bg-primary);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-xl);
        backdrop-filter: blur(10px);
        width: 100vw;
        max-width: 100vw;
        min-width: 95vw;
        position: relative;
        overflow: hidden;
    }
    
    .calendar-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--gray-300), transparent);
    }

    /* FullCalendar Timeline Customizations */
    .fc {
        max-width: 100vw;
    }

    /* Modern Header Toolbar Styling */
    .fc .fc-toolbar.fc-header-toolbar {
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--gray-200);
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .fc .fc-toolbar-title {
        font-size: 1.75rem;
        font-weight: var(--font-weight-bold);
        color: var(--gray-800);
        background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-600) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .fc .fc-button {
        background: var(--bg-primary);
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        text-transform: capitalize;
        font-weight: var(--font-weight-medium);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm) var(--spacing-md);
        box-shadow: var(--shadow-xs);
        transition: all var(--transition-fast);
        position: relative;
        overflow: hidden;
    }
    
    .fc .fc-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left var(--transition-base);
    }
    
    .fc .fc-button:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .fc .fc-button:hover::before {
        left: 100%;
    }

    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active {
        background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
        border-color: #1D4ED8;
        color: #fff;
        box-shadow: var(--shadow-lg);
    }
    
    .fc .fc-today-button {
        background: linear-gradient(135deg, var(--status-confirmed) 0%, #059669 100%);
        border-color: #059669;
        color: #fff;
    }

    /* Resource Area (Left Property List) Styling */
    .fc .fc-resource-area-header, .fc .fc-resource-timeline-divider, .fc .fc-resource-area-cushion {
        display: none !important;
    }
    
    .fc .fc-timeline-lane-frame {
        border-left: none !important;
        margin-left: 0 !important;
        padding-left: 0 !important;
    }

    .fc .fc-timeline-header-row-0 {
        display: none !important;
    }

    .fc .fc-col-header, .fc .fc-timeline-header {
        display: table-header-group !important;
        background: #f8f9fa;
        z-index: 2;
    }

    /* Timeline Area Styling */
    .fc .fc-timeline-slot-label { /* Day numbers / labels */
        font-size: 0.85em;
        color: #6c757d;
    }
    
    .fc .fc-timeline-slot { /* Vertical day dividers */
       border-right: 1px solid #eee;
    }

    /* Modern Event Styling */
    .fc-timeline-event {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-lg);
        font-size: 0.875rem;
        font-weight: var(--font-weight-medium);
        margin-top: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        color: #fff;
        border: none;
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(8px);
        position: relative;
        transition: all var(--transition-fast);
        background: linear-gradient(135deg, var(--event-bg, #008489) 0%, var(--event-bg-dark, #006b70) 100%) !important;
    }
    
    .fc-timeline-event::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.05) 100%);
        border-radius: inherit;
        pointer-events: none;
    }
    
    .fc-timeline-event:hover {
        transform: translateY(-1px) scale(1.02);
        box-shadow: var(--shadow-lg);
        z-index: 10;
    }
    
    .fc-timeline-event:active {
        transform: translateY(0) scale(0.98);
        transition-duration: 100ms;
    }

    /* Platform-Specific Event Colors with Enhanced Accessibility */
    .fc-timeline-event.airbnb-event {
        --event-bg: var(--airbnb-accessible);
        --event-bg-dark: #C71E23;
        background: linear-gradient(135deg, var(--event-bg) 0%, var(--event-bg-dark) 100%) !important;
    }
    
    .fc-timeline-event.vrbo-event {
        --event-bg: var(--vrbo-accessible);
        --event-bg-dark: #1565C0;
        background: linear-gradient(135deg, var(--event-bg) 0%, var(--event-bg-dark) 100%) !important;
    }
    
    .fc-timeline-event.booking-event {
        --event-bg: var(--booking-accessible);
        --event-bg-dark: #0A3D91;
        background: linear-gradient(135deg, var(--event-bg) 0%, var(--event-bg-dark) 100%) !important;
    }
    
    .fc-timeline-event.direct-event {
        --event-bg: var(--direct-accessible);
        --event-bg-dark: #1B5E20;
        background: linear-gradient(135deg, var(--event-bg) 0%, var(--event-bg-dark) 100%) !important;
    }
    
    .fc-timeline-event.blocked-event {
        --event-bg: var(--status-blocked);
        --event-bg-dark: #4B5563;
        background: linear-gradient(135deg, var(--event-bg) 0%, var(--event-bg-dark) 100%) !important;
        opacity: 0.8;
    }
    
    .fc-timeline-event.other-event {
        --event-bg: var(--gray-600);
        --event-bg-dark: var(--gray-700);
        background: linear-gradient(135deg, var(--event-bg) 0%, var(--event-bg-dark) 100%) !important;
    }

    /* Remove default event border color */
    .fc-event {
        border-color: transparent !important;
    }
    
    /* Ensure good contrast for event text */
    .fc-event-title {
        color: #fff;
    }

    /* Adjusting height - remove fixed height if content should dictate */
    #calendar {
        width: 98vw;
        min-width: 95vw;
        max-width: 100vw;
        margin: 0 auto;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        height: auto;
        min-height: 600px;
    }
    
    /* Make timeline rows taller to better display booking information */
    .fc .fc-timeline-lane {
        height: 60px !important;
        min-height: 60px !important;
    }
    
    .fc .fc-timeline-lane-frame {
        height: 60px !important;
        min-height: 60px !important;
    }
    
    /* Resource (property) row styling */
    .fc .fc-resource {
        height: 60px !important;
        min-height: 60px !important;
        padding: 8px 12px !important;
        border-bottom: 2px solid #e9ecef !important;
    }
    
    /* Better event spacing within taller rows */
    .fc-timeline-event {
        margin-top: 4px !important;
        margin-bottom: 4px !important;
        height: 48px !important;
        line-height: 48px !important;
        display: flex !important;
        align-items: center !important;
    }
    
    /* Timeline styles */
    .fc-timeline-slot {
        border: 1px solid #f0f0f0;
    }
    .fc-timeline-slot-minor {
        border-style: dotted;
    }
    
    /* Highlight for selected resource */
    .fc-resource-cell.highlighted {
        background-color: rgba(66, 139, 202, 0.15) !important;
        font-weight: bold;
    }
    
    /* Enhanced Property Sidebar */
    .sidebar-property-list {
        background: var(--bg-primary);
        border-right: 1px solid var(--gray-200);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
    }
    
    .property-list-item {
        transition: all var(--transition-fast);
        border-radius: var(--radius-md);
        margin: var(--spacing-xs) var(--spacing-sm);
        padding: var(--spacing-md) !important;
        position: relative;
        overflow: hidden;
    }
    
    .property-list-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: transparent;
        transition: all var(--transition-fast);
    }
    
    .property-list-item:hover {
        background: var(--gray-50);
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }
    
    .property-list-item.active {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.05) 100%);
        border-left: none;
        color: var(--gray-800);
        font-weight: var(--font-weight-medium);
        transform: translateX(6px);
        box-shadow: var(--shadow-md);
    }
    
    .property-list-item.active::before {
        background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
        width: 4px;
    }
    
    .property-color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: var(--spacing-md);
        box-shadow: var(--shadow-xs);
        border: 2px solid var(--bg-primary);
        transition: all var(--transition-fast);
    }
    
    .property-list-item:hover .property-color-dot {
        transform: scale(1.2);
        box-shadow: var(--shadow-sm);
    }
    
    .property-search-container {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--gray-200);
        background: var(--bg-secondary);
    }
    
    #propertySearch {
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        background: var(--bg-primary);
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-xs);
    }
    
    #propertySearch:focus {
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), var(--shadow-sm);
        outline: none;
    }

    /* Mobile-responsive sidebar */
    @media (max-width: 992px) {
        .sidebar-property-list { 
            display: none !important; 
        }
        
        .main-calendar-area {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Mobile-friendly navigation */
        .top-nav {
            padding: 0.5rem 1rem;
        }
        
        .top-nav-links a {
            padding: 0.5rem;
            font-size: 0.9em;
        }
        
        .top-nav-brand {
            font-size: 1.1em;
        }
    }
    
    /* Desktop: Show sidebar */
    @media (min-width: 993px) {
        .sidebar-property-list { 
            display: block !important; 
        }
    }

    .property-color-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    /* Mobile-First Responsive Design */
    @media (max-width: 768px) {
        .calendar-container {
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
        }
        
        /* Mobile calendar optimization */
        #calendar {
            width: 100vw;
            min-width: 95vw;
            font-size: 0.85em;
        }
        
        /* Adjust FullCalendar for mobile */
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .fc .fc-toolbar-title {
            font-size: 1.25em;
            margin: 0.5em 0;
        }
        
        .fc .fc-button-group {
            display: flex;
            justify-content: center;
        }
        
        .fc .fc-button {
            font-size: 0.8em;
            padding: 0.4em 0.6em;
        }
        
        /* Timeline optimization for mobile */
        .fc .fc-timeline-lane {
            height: 50px !important;
            min-height: 50px !important;
        }
        
        .fc .fc-timeline-lane-frame {
            height: 50px !important;
            min-height: 50px !important;
        }
        
        .fc .fc-resource {
            height: 50px !important;
            min-height: 50px !important;
            padding: 6px 8px !important;
            font-size: 0.85em;
        }
        
        .fc-timeline-event {
            height: 38px !important;
            line-height: 38px !important;
            font-size: 0.8em;
            margin-top: 3px !important;
            margin-bottom: 3px !important;
        }
        
        /* Hide detailed info on very small screens */
        .event-content .event-details {
            display: none;
        }
        
        /* Improve touch targets */
        .fc .fc-event {
            min-height: 36px;
            cursor: pointer;
        }
        
        /* Optimize timeline header for mobile */
        .fc .fc-timeline-header th {
            min-width: 80px;
            font-size: 0.75em;
        }
    }
    
    /* Large mobile / Small tablet */
    @media (min-width: 576px) and (max-width: 992px) {
        .calendar-container {
            padding: 15px;
        }
        
        .fc .fc-toolbar {
            flex-direction: row;
        }
        
        .fc .fc-button {
            font-size: 0.9em;
        }
        
        .fc .fc-timeline-lane {
            height: 55px !important;
        }
        
        .fc-timeline-event {
            height: 42px !important;
            line-height: 42px !important;
        }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
        .fc .fc-button {
            min-height: 44px;
            min-width: 44px;
        }
        
        .fc .fc-event {
            min-height: 44px;
        }
        
        .fc .fc-daygrid-event {
            padding: 4px 6px;
        }
    }
    /* Modern Event Content Styling */
    .event-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-sm);
        padding: 0 var(--spacing-md);
        border-radius: var(--radius-lg);
        color: #fff;
        min-width: 140px;
        font-size: 0.875rem;
        font-weight: var(--font-weight-medium);
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .event-title {
        font-weight: var(--font-weight-semibold);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
    }
    
    .status-pill {
        background: rgba(255, 255, 255, 0.9);
        color: var(--gray-800);
        border-radius: var(--radius-md);
        padding: 2px var(--spacing-sm);
        font-size: 0.75rem;
        font-weight: var(--font-weight-semibold);
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
        margin-left: var(--spacing-xs);
        backdrop-filter: blur(4px);
        box-shadow: var(--shadow-xs);
        transition: all var(--transition-fast);
    }
    
    .status-pill:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.05);
    }
    
    .checkout-date {
        font-size: 0.75rem;
        font-weight: var(--font-weight-semibold);
        background: rgba(255, 255, 255, 0.9);
        color: var(--gray-800);
        border-radius: var(--radius-md);
        padding: 2px var(--spacing-sm);
        margin-left: var(--spacing-xs);
        backdrop-filter: blur(4px);
        box-shadow: var(--shadow-xs);
        display: inline-flex;
        align-items: center;
    }
    
    .event-meta {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        flex-shrink: 0;
    }
    
    .platform-badge {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        border-radius: var(--radius-sm);
        padding: 1px var(--spacing-xs);
        font-size: 0.6875rem;
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .fc-event-content, .event-content {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 8px;
    }
    .fc-event-content .event-title, .event-content .event-title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .fc-event-content .status-pill, .event-content .status-pill {
        background: #fff;
        color: #222;
        border-radius: 10px;
        padding: 1px 8px;
        font-size: 0.8em;
        font-weight: 600;
        display: inline-block;
        white-space: nowrap;
        margin-left: 4px;
    }
    .fc-event-content .checkout-date, .event-content .checkout-date {
        font-size: 0.8em;
        font-weight: 600;
        background: #fff;
        color: #222;
        border-radius: 10px;
        padding: 1px 8px;
        margin-left: 4px;
    }
    .fc-timeline-event, .fc-event {
        border-radius: 20px !important;
        font-size: 1em !important;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        border: none !important;
        display: flex;
        align-items: center;
        min-width: 120px;
        position: relative;
        background: var(--event-bg, #008489) !important;
        color: #fff !important;
        padding: 6px 16px !important;
        gap: 8px;
    }
    
    /* Loading States and Skeleton Screens */
    .loading-skeleton {
        background: var(--gray-200);
        background-image: linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.4) 50%, transparent 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--radius-md);
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .event-skeleton {
        height: 48px;
        border-radius: var(--radius-lg);
        margin: var(--spacing-xs) 0;
    }
    
    .property-skeleton {
        height: 64px;
        margin: var(--spacing-sm);
        border-radius: var(--radius-md);
    }
    
    /* Calendar Loading State */
    .calendar-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        gap: var(--spacing-lg);
    }
    
    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--gray-200);
        border-top: 4px solid #3B82F6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-text {
        color: var(--gray-600);
        font-weight: var(--font-weight-medium);
        font-size: 1.1rem;
    }
    
    /* Improved Focus States */
    .fc .fc-button:focus,
    .property-list-item:focus,
    #propertySearch:focus {
        outline: 2px solid #3B82F6;
        outline-offset: 2px;
    }
    
    /* Reduced Motion Preferences */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
        
        .loading-skeleton {
            background: var(--gray-200);
            animation: none;
        }
    }
</style>
{% endblock %}

{% block content %}
{# Simple top navigation bar like the image #}
<nav class="top-nav">
    <div class="top-nav-brand">OpenBnB</div> {# Placeholder brand name #}
    <div class="top-nav-links">
        <a href="#">Today</a>
        <a href="#" class="active">Calendar</a>
        <a href="#">Tasks</a>
        <a href="#">Work Orders</a>
        <a href="#">Messages</a>
        {# Add more links as needed #}
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar: Property List -->
        <div class="col-lg-3 d-none d-lg-block sidebar-property-list" style="min-height:700px; padding:0;">
            <div class="property-search-container">
                <input type="text" class="form-control" id="propertySearch" placeholder="🔍 Search properties...">
            </div>
            <div id="propertyList" class="list-group list-group-flush">
                {% for resource in resources %}
                <a href="#" class="list-group-item list-group-item-action d-flex align-items-center property-list-item" data-resource-id="{{ resource.id }}">
                    <span class="property-color-dot" style="background: {{ resource.color }};"></span>
                    <img src="{{ resource.image_url }}" alt="{{ resource.title }}" class="rounded me-3" style="width:48px; height:48px; object-fit:cover; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-gray-800">{{ resource.title }}</div>
                        <div class="text-muted small d-flex align-items-center gap-1">
                            📍 {{ resource.city }}, {{ resource.state }}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-light text-dark rounded-pill px-2 py-1" style="font-size: 0.7rem;">Active</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        <!-- Main Calendar Area -->
        <div class="col-lg-9 col-12 main-calendar-area">
            <div class="calendar-container">
                <div id="calendar">
                    <!-- Loading State -->
                    <div class="calendar-loading" id="calendarLoading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading your property calendar...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Property:</label>
                    <span id="property-name"></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Guest:</label>
                    <span id="guest-summary"></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Dates:</label>
                    <span id="date-range"></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Source:</label>
                    <span id="source"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="assign-task-btn" href="#" class="btn btn-primary">Assign Task</a>
                <a id="repair-request-btn" href="#" class="btn btn-warning">Repair Request</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
{# Include FullCalendar v5 with scheduler - using more reliable CDN #}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/resource@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/resource-timeline@6.1.10/index.global.min.js"></script>
{# Include Bootstrap JS for modal #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
var resources = {{ resources|tojson|safe }} || [];
var rawEvents = {{ events|tojson|safe }} || [];

console.log('Resources loaded:', resources.length);
console.log('Events loaded:', rawEvents.length);

document.addEventListener('DOMContentLoaded', function() {
    // Show loading state
    var loadingEl = document.getElementById('calendarLoading');
    var calendarEl = document.getElementById('calendar');
    
    // Enhanced event deduplication with loading feedback
    var uniqueEvents = {};
    var deduplicatedEvents = [];
    
    // Simulate processing for better UX
    setTimeout(function() {
        rawEvents.forEach(function(event) {
            if (!event || !event.start) return;
            if (!event.resourceId && event.extendedProps && event.extendedProps.property_id) {
                event.resourceId = String(event.extendedProps.property_id);
            }
            var uniqueId = event.external_id || event.id;
            if (!uniqueEvents[uniqueId]) {
                uniqueEvents[uniqueId] = event;
                deduplicatedEvents.push(event);
            }
        });
        
        // Initialize calendar after processing
        initializeCalendar();
    }, 1000);
    
    function initializeCalendar() {

        console.log('Calendar element found:', !!calendarEl);
        console.log('FullCalendar available:', typeof FullCalendar);
        
        if (!calendarEl) {
            console.error('Calendar element not found');
            showErrorState('Calendar element not found');
            return;
        }
        
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar library not loaded');
            showErrorState('Calendar library failed to load');
            return;
        }
    
    // Detect mobile device for responsive configuration
    var isMobile = window.innerWidth <= 768;
    var isTablet = window.innerWidth > 768 && window.innerWidth <= 992;
    
    // Mobile-first responsive calendar configuration
    var calendarConfig = {
        height: isMobile ? 'auto' : 'auto',
        aspectRatio: isMobile ? 1.0 : 1.35,
        navLinks: true,
        selectable: true,
        editable: false,
        nowIndicator: true,
        events: deduplicatedEvents,
        headerToolbar: isMobile ? {
            left: 'prev,next',
            center: 'title',
            right: 'today'
        } : {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        footerToolbar: isMobile ? {
            center: 'dayGridMonth,listWeek'
        } : false,
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        eventDisplay: 'block',
        // Mobile-specific event sizing
        eventMinHeight: isMobile ? 30 : 20,
        eventShortHeight: isMobile ? 25 : 20,
        // Handle window resize for responsiveness
        windowResizeDelay: 100,
        eventContent: function(arg) {
            var content = document.createElement('div');
            content.classList.add('event-content');
            content.style.display = 'flex';
            content.style.alignItems = 'center';
            content.style.justifyContent = 'space-between';
            content.style.padding = '4px 8px';
            content.style.height = '100%';
            content.style.overflow = 'hidden';
            
            // Set background color from resource
            var resource = resources.find(r => r.id == arg.event.getResources()[0]?.id || arg.event.extendedProps.property_id);
            var bgColor = resource && resource.color ? resource.color : '#008489';
            content.style.background = bgColor;
            content.style.borderRadius = '4px';
            content.style.color = '#fff';
            
            // Left side: Guest name and platform
            var leftDiv = document.createElement('div');
            leftDiv.style.flex = '1';
            leftDiv.style.minWidth = '0'; // Allow text truncation
            
            var titleEl = document.createElement('div');
            titleEl.style.fontWeight = 'bold';
            titleEl.style.fontSize = '13px';
            titleEl.style.whiteSpace = 'nowrap';
            titleEl.style.overflow = 'hidden';
            titleEl.style.textOverflow = 'ellipsis';
            titleEl.innerHTML = arg.event.title;
            leftDiv.appendChild(titleEl);
            
            if (arg.event.extendedProps.platform) {
                var platformEl = document.createElement('div');
                platformEl.style.fontSize = '11px';
                platformEl.style.opacity = '0.9';
                platformEl.innerHTML = arg.event.extendedProps.platform;
                leftDiv.appendChild(platformEl);
            }
            
            content.appendChild(leftDiv);
            
            // Right side: Status and amount
            var rightDiv = document.createElement('div');
            rightDiv.style.display = 'flex';
            rightDiv.style.flexDirection = 'column';
            rightDiv.style.alignItems = 'flex-end';
            rightDiv.style.marginLeft = '8px';
            
            if (arg.event.extendedProps.amount) {
                var amountEl = document.createElement('div');
                amountEl.style.fontSize = '12px';
                amountEl.style.fontWeight = 'bold';
                amountEl.innerHTML = '$' + arg.event.extendedProps.amount;
                rightDiv.appendChild(amountEl);
            }
            
            if (arg.event.extendedProps.status) {
                var statusEl = document.createElement('div');
                statusEl.style.fontSize = '10px';
                statusEl.style.backgroundColor = 'rgba(255,255,255,0.2)';
                statusEl.style.padding = '1px 4px';
                statusEl.style.borderRadius = '8px';
                statusEl.style.marginTop = '2px';
                statusEl.innerHTML = arg.event.extendedProps.status;
                rightDiv.appendChild(statusEl);
            }
            
            content.appendChild(rightDiv);
            
            return { domNodes: [content] };
        },
        eventDidMount: function(info) {
            try {
                new bootstrap.Tooltip(info.el, {
                    title: function() {
                        return `
                            <div>
                                <p><strong>${info.event.extendedProps.property_name || 'Property'}</strong></p>
                                <p>${info.event.title}</p>
                                <p>${new Date(info.event.start).toLocaleDateString()} - ${new Date(info.event.end).toLocaleDateString()}</p>
                                <p>${info.event.extendedProps.service || 'Direct'}</p>
                            </div>
                        `;
                    },
                    html: true,
                    placement: 'top'
                });
            } catch (e) {}
        },
        eventClick: function(info) {
            showEventModal(info.event);
        },
        select: function(info) {
            console.log('Selected:', info);
        }
    };
    
    // Try to add resource timeline if available
    if (typeof FullCalendar !== 'undefined' && FullCalendar.resourceTimelinePlugin) {
        console.log('Resource timeline available, using advanced view');
        calendarConfig.initialView = 'resourceTimelineMonth';
        calendarConfig.schedulerLicenseKey = 'GPL-My-Project-Is-Open-Source';
        calendarConfig.resources = resources;
        calendarConfig.resourceAreaWidth = '25%';
        calendarConfig.headerToolbar.right = 'resourceTimelineDay,resourceTimelineWeek,resourceTimelineMonth';
    } else {
        console.log('Resource timeline not available, using standard month view');
    }
    
    var calendar = new FullCalendar.Calendar(calendarEl, calendarConfig);
    
        try {
            calendar.render();
            console.log('Calendar rendered successfully');
            
            // Hide loading state with smooth transition
            setTimeout(function() {
                if (loadingEl) {
                    loadingEl.style.opacity = '0';
                    loadingEl.style.transform = 'scale(0.95)';
                    setTimeout(function() {
                        loadingEl.style.display = 'none';
                    }, 300);
                }
                
                // Show success feedback briefly
                showSuccessMessage('Calendar loaded successfully!');
            }, 500);
            
        } catch (error) {
            console.error('Error rendering calendar:', error);
            showErrorState('Failed to render calendar: ' + error.message);
        }
    }
    
    function showErrorState(message) {
        if (loadingEl) {
            loadingEl.innerHTML = `
                <div class="text-center">
                    <div class="alert alert-error d-inline-block">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                </div>
            `;
        }
    }
    
    function showSuccessMessage(message) {
        var successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success position-fixed';
        successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        successAlert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ${message}
        `;
        
        document.body.appendChild(successAlert);
        
        setTimeout(function() {
            successAlert.style.opacity = '0';
            setTimeout(function() {
                if (successAlert.parentNode) {
                    successAlert.parentNode.removeChild(successAlert);
                }
            }, 300);
        }, 3000);
    }

    function showEventModal(event) {
        try {
            var modal = new bootstrap.Modal(document.getElementById('eventModal'));
            document.getElementById('property-name').textContent = event.extendedProps.property_name || 'Unknown Property';
            
            // Enhanced guest information
            var guestInfo = event.title || 'No guest information';
            if (event.extendedProps.guest_count) {
                guestInfo += ` (${event.extendedProps.guest_count} guests)`;
            }
            if (event.extendedProps.amount) {
                guestInfo += ` - $${event.extendedProps.amount}`;
            }
            document.getElementById('guest-summary').textContent = guestInfo;
            
            var startDate = new Date(event.start).toLocaleDateString();
            var endDate = startDate;
            if (event.end) {
                var end = new Date(event.end);
                end.setDate(end.getDate() - 1);
                endDate = end.toLocaleDateString();
            }
            document.getElementById('date-range').textContent = startDate + ' to ' + endDate;
            
            // Show platform and status
            var sourceText = event.extendedProps.platform || 'Direct Booking';
            if (event.extendedProps.status) {
                sourceText += ` (${event.extendedProps.status})`;
            }
            document.getElementById('source').textContent = sourceText;
            
            var bookingId = event.id;
            var assignTaskBtn = document.getElementById('assign-task-btn');
            if (assignTaskBtn) assignTaskBtn.href = '/tasks/create?booking_id=' + bookingId;
            var repairRequestBtn = document.getElementById('repair-request-btn');
            if (repairRequestBtn) repairRequestBtn.href = '/tasks/repair_requests/create?property_id=' + event.extendedProps.property_id;
            modal.show();
        } catch (e) {
            console.error('Error showing event modal:', e);
        }
    }

    // Sidebar search logic
    document.getElementById('propertySearch').addEventListener('input', function() {
        var val = this.value.toLowerCase();
        document.querySelectorAll('.property-list-item').forEach(function(item) {
            var name = item.querySelector('.fw-bold').textContent.toLowerCase();
            item.style.display = name.includes(val) ? '' : 'none';
        });
    });

    // Sidebar click logic
    document.querySelectorAll('.property-list-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            var resourceId = this.getAttribute('data-resource-id');
            document.querySelectorAll('.property-list-item').forEach(function(p) { p.classList.remove('active'); });
            this.classList.add('active');
            try {
                calendar.scrollToResource(resourceId);
            } catch (e) {}
        });
    });
});
</script>
{% endblock %}