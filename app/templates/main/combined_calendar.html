{% extends "base.html" %}

{% block styles %}
{{ super() }}
{# Use FullCalendar v6 basic #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

<style>
    /* CSS Custom Properties - Design System */
    :root {
        /* Spacing Scale */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-2xl: 48px;
        
        /* Border Radius Scale */
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-2xl: 24px;
        
        /* Shadow Scale */
        --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
        --shadow-lg: 0 10px 15px rgba(0,0,0,0.10), 0 4px 6px rgba(0,0,0,0.05);
        --shadow-xl: 0 20px 25px rgba(0,0,0,0.15), 0 8px 10px rgba(0,0,0,0.04);
        
        /* Platform Colors - Accessible */
        --airbnb-primary: #FF5A5F;
        --airbnb-accessible: #E31E23;
        --vrbo-primary: #3D67FF;
        --vrbo-accessible: #1976D2;
        --booking-primary: #003580;
        --booking-accessible: #0D47A1;
        --direct-primary: #34C759;
        --direct-accessible: #2E7D32;
        
        /* Status Colors */
        --status-confirmed: #10B981;
        --status-pending: #F59E0B;
        --status-cancelled: #EF4444;
        --status-blocked: #6B7280;
        
        /* Neutral Colors */
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
        
        /* Background & Surface */
        --bg-primary: #FFFFFF;
        --bg-secondary: var(--gray-50);
        --bg-tertiary: var(--gray-100);
        
        /* Typography */
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        
        /* Animation */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        color: var(--gray-800);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
        line-height: 1.6;
    }

    .calendar-container {
        margin-top: var(--spacing-lg);
        background: var(--bg-primary);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-xl);
        backdrop-filter: blur(10px);
        width: 100vw;
        max-width: 100vw;
        min-width: 95vw;
        position: relative;
        overflow: hidden;
    }
    
    .calendar-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--gray-300), transparent);
    }

    /* Enhanced Property Sidebar */
    .sidebar-property-list {
        background: var(--bg-primary);
        border-right: 1px solid var(--gray-200);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
    }
    
    .property-list-item {
        transition: all var(--transition-fast);
        border-radius: var(--radius-md);
        margin: var(--spacing-xs) var(--spacing-sm);
        padding: var(--spacing-md) !important;
        position: relative;
        overflow: hidden;
    }
    
    .property-list-item:hover {
        background: var(--gray-50);
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }
    
    .property-color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: var(--spacing-md);
        box-shadow: var(--shadow-xs);
        border: 2px solid var(--bg-primary);
        transition: all var(--transition-fast);
    }
    
    .property-search-container {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--gray-200);
        background: var(--bg-secondary);
    }
    
    #propertySearch {
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        background: var(--bg-primary);
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-xs);
    }
    
    #propertySearch:focus {
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), var(--shadow-sm);
        outline: none;
    }

    /* Simple Calendar Styling */
    #calendar {
        min-height: 600px;
    }

    /* Basic FullCalendar Styling */
    .fc {
        max-width: 100%;
    }

    .fc .fc-toolbar.fc-header-toolbar {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .fc .fc-toolbar-title {
        font-size: 1.75rem;
        font-weight: var(--font-weight-bold);
        color: var(--gray-800);
    }

    .fc .fc-button {
        background: var(--bg-primary);
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm) var(--spacing-md);
        box-shadow: var(--shadow-xs);
        transition: all var(--transition-fast);
    }

    .fc .fc-button:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    /* Platform-Specific Event Colors */
    .fc-event.airbnb-event {
        background: linear-gradient(135deg, var(--airbnb-accessible) 0%, #C71E23 100%) !important;
        border: none !important;
    }
    
    .fc-event.vrbo-event {
        background: linear-gradient(135deg, var(--vrbo-accessible) 0%, #1565C0 100%) !important;
        border: none !important;
    }
    
    .fc-event.booking-event {
        background: linear-gradient(135deg, var(--booking-accessible) 0%, #0A3D91 100%) !important;
        border: none !important;
    }
    
    .fc-event.direct-event {
        background: linear-gradient(135deg, var(--direct-accessible) 0%, #1B5E20 100%) !important;
        border: none !important;
    }

    .fc-event {
        border-radius: var(--radius-lg) !important;
        padding: var(--spacing-xs) var(--spacing-sm) !important;
        font-weight: var(--font-weight-medium) !important;
        box-shadow: var(--shadow-sm) !important;
        transition: all var(--transition-fast) !important;
    }

    .fc-event:hover {
        transform: translateY(-1px) scale(1.02) !important;
        box-shadow: var(--shadow-lg) !important;
    }

    /* Property type icons */
    .property-type-icon {
        width: 20px;
        height: 20px;
        margin-right: var(--spacing-sm);
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .property-type-house { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23374151"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>'); }
    .property-type-suite { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23374151"><path d="M12 2L2 7v10c0 5.55 3.84 9 9 9s9-3.45 9-9V7l-8-5zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>'); }
    .property-type-apartment { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23374151"><path d="M17 11V3H7v4H3v14h8v-4h2v4h8V11h-4zM7 19H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm4 8H9v-2h2v2zm0-4H9v-2h2v2zm0-4H9V9h2v2zm0-4H9V5h2v2zm4 12h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2z"/></svg>'); }
</style>
{% endblock %}

{% block content %}
{# Simple top navigation bar #}
<nav class="top-nav">
    <div class="top-nav-brand">OpenBnB</div>
    <div class="top-nav-links">
        <a href="#">Today</a>
        <a href="#" class="active">Calendar</a>
        <a href="#">Tasks</a>
        <a href="#">Work Orders</a>
        <a href="#">Messages</a>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Enhanced Sidebar: Property List -->
        <div class="col-lg-3 d-none d-lg-block sidebar-property-list" style="min-height:700px; padding:0;">
            <div class="property-search-container">
                <input type="text" class="form-control" id="propertySearch" placeholder="🔍 Search properties...">
            </div>
            <div id="propertyList" class="list-group list-group-flush">
                {% for resource in resources %}
                <a href="#" class="list-group-item list-group-item-action d-flex align-items-center property-list-item" data-resource-id="{{ resource.id }}">
                    <span class="property-color-dot" style="background: {{ resource.color }};"></span>
                    <div class="property-type-icon property-type-{{ resource.property_type or 'house' }}"></div>
                    <img src="{{ resource.image_url or '/static/img/default-property.jpg' }}" alt="{{ resource.title }}" class="rounded me-3" style="width:48px; height:48px; object-fit:cover; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-gray-800">{{ resource.title }}</div>
                        <div class="text-muted small d-flex align-items-center gap-1">
                            📍 {{ resource.city }}, {{ resource.state }}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-light text-dark rounded-pill px-2 py-1" style="font-size: 0.7rem;">Active</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        <!-- Main Calendar Area -->
        <div class="col-lg-9 col-12 main-calendar-area">
            <div class="calendar-container">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Property:</label>
                    <span id="property-name"></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Guest:</label>
                    <span id="guest-summary"></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Dates:</label>
                    <span id="date-range"></span>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Source:</label>
                    <span id="source"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="assign-task-btn" href="#" class="btn btn-primary">Assign Task</a>
                <a id="repair-request-btn" href="#" class="btn btn-warning">Repair Request</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
{# Include FullCalendar v6 basic #}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
{# Include Bootstrap JS for modal #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
var resources = {{ resources|tojson|safe }} || [];
var rawEvents = {{ events|tojson|safe }} || [];

console.log('Resources loaded:', resources.length);
console.log('Events loaded:', rawEvents.length);

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting calendar initialization...');
    
    var calendarEl = document.getElementById('calendar');
    
    if (!calendarEl) {
        console.error('Calendar element not found');
        return;
    }

    if (typeof FullCalendar === 'undefined') {
        console.error('FullCalendar library not loaded');
        return;
    }

    // Process events
    var processedEvents = [];
    rawEvents.forEach(function(event) {
        if (event && event.start) {
            if (!event.resourceId && event.extendedProps && event.extendedProps.property_id) {
                event.resourceId = String(event.extendedProps.property_id);
            }
            processedEvents.push(event);
        }
    });

    console.log('Processed events:', processedEvents.length);

    // Create calendar with simplified view
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        events: processedEvents,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        eventClassNames: function(arg) {
            var platform = arg.event.extendedProps.platform || 'direct';
            return [platform.toLowerCase() + '-event'];
        },
        eventClick: function(info) {
            showEventModal(info.event);
        },
        eventDisplay: 'block',
        dayMaxEvents: 3
    });

    try {
        calendar.render();
        console.log('Calendar rendered successfully!');
    } catch (error) {
        console.error('Error rendering calendar:', error);
        calendarEl.innerHTML = '<div class="alert alert-warning">Calendar could not be loaded. Error: ' + error.message + '</div>';
    }

    function showEventModal(event) {
        try {
            var modal = new bootstrap.Modal(document.getElementById('eventModal'));
            document.getElementById('property-name').textContent = event.extendedProps.property_name || 'Unknown Property';
            document.getElementById('guest-summary').textContent = event.title || 'No guest information';
            
            var startDate = new Date(event.start).toLocaleDateString();
            var endDate = event.end ? new Date(event.end).toLocaleDateString() : startDate;
            document.getElementById('date-range').textContent = startDate + ' to ' + endDate;
            document.getElementById('source').textContent = event.extendedProps.platform || 'Direct Booking';
            
            modal.show();
        } catch (e) {
            console.error('Error showing event modal:', e);
        }
    }

    // Enhanced search functionality
    var searchInput = document.getElementById('propertySearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            var val = this.value.toLowerCase();
            document.querySelectorAll('.property-list-item').forEach(function(item) {
                var name = item.querySelector('.fw-semibold').textContent.toLowerCase();
                item.style.display = name.includes(val) ? '' : 'none';
            });
        });
    }

    // Property selection
    document.querySelectorAll('.property-list-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            var resourceId = this.getAttribute('data-resource-id');
            
            document.querySelectorAll('.property-list-item').forEach(function(p) {
                p.classList.remove('active');
            });
            this.classList.add('active');
            
            try {
                if (calendar && calendar.scrollToResource) {
                    calendar.scrollToResource(resourceId);
                }
            } catch (e) {
                console.warn('Could not scroll to resource:', e);
            }
        });
    });
});
</script>
{% endblock %}