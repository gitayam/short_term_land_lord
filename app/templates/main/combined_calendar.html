{% extends "base.html" %}

{% block styles %}
{{ super() }}
{# Use FullCalendar v5 with scheduler #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">

<style>
    body {
        background-color: #f8f9fa; /* Light background */
        color: #212529; /* Standard text color */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .calendar-container {
        margin-top: 20px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* FullCalendar Timeline Customizations */
    .fc {
        max-width: 100%; /* Allow calendar to use full width */
    }

    /* Header Toolbar Styling */
    .fc .fc-toolbar.fc-header-toolbar {
        margin-bottom: 1.5em;
        padding-bottom: 1em;
        border-bottom: 1px solid #e9ecef;
    }

    .fc .fc-toolbar-title {
        font-size: 1.5em;
        font-weight: 600;
    }

    .fc .fc-button {
        background-color: #fff;
        border: 1px solid #ced4da;
        color: #495057;
        text-transform: capitalize;
        box-shadow: none;
        transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }
    .fc .fc-button:hover {
        background-color: #e9ecef;
    }

    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
    
    .fc .fc-today-button {
        /* Optionally highlight today button */
    }

    /* Resource Area (Left Property List) Styling */
    .fc .fc-resource-area-header { /* Target the 'Properties' header */
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 0.75em 0.5em;
    }
    
    .fc .fc-resource-area-header .fc-scrollgrid-shrink-cushion {
        font-size: 1em; /* Ensure header text size is appropriate */
        line-height: 1.5;
    }


    .fc .fc-datagrid-cell-main { /* Resource Title (Property Name) */
        font-weight: 500;
        font-size: 0.9em;
        color: #343a40;
    }
    
    .fc .fc-datagrid-cell { /* Resource Row */
        border-bottom: 1px solid #eee; /* Lighter line between properties */
    }

    /* Timeline Area Styling */
    .fc .fc-timeline-slot-label { /* Day numbers / labels */
        font-size: 0.85em;
        color: #6c757d;
    }
    
    .fc .fc-timeline-slot { /* Vertical day dividers */
       border-right: 1px solid #eee;
    }

    /* Event Styling */
    .fc-timeline-event {
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        margin-top: 2px;
        margin-bottom: 2px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        color: #fff; /* Default text color for events */
        border: none;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .fc-timeline-event:hover {
       opacity: 0.85;
    }

    /* Source-specific event colors */
    .fc-timeline-event.airbnb-event {
        background-color: #FF5A5F; /* Airbnb Red */
    }
    
    .fc-timeline-event.vrbo-event {
        background-color: #3D67FF; /* VRBO Blue */
    }
    
    .fc-timeline-event.booking-event { /* Added example for Booking.com */
       background-color: #003580; /* Booking.com Blue */
    }
    
    .fc-timeline-event.direct-event {
        background-color: #34C759; /* Green */
    }
    
    .fc-timeline-event.blocked-event {
        background-color: #8E8E93; /* Grey */
    }
    
    .fc-timeline-event.other-event {
        background-color: #767676; /* Darker Grey */
    }

    /* Remove default event border color */
    .fc-event {
        border-color: transparent !important;
    }
    
    /* Ensure good contrast for event text */
    .fc-event-title {
        color: #fff;
    }

    /* Adjusting height - remove fixed height if content should dictate */
    #calendar {
        min-height: 600px; /* Ensure a minimum height */
        height: auto; /* Adjust height based on number of resources */
    }
    
    /* Add simple top navigation like the image */
    .top-nav {
        background-color: #fff;
        padding: 10px 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .top-nav-brand {
        font-weight: bold;
        color: #FF5A5F; /* Example Airbnb-like color */
        font-size: 1.5em;
    }
    .top-nav-links a {
        text-decoration: none;
        color: #495057;
        padding: 8px 12px;
        border-radius: 4px;
    }
    .top-nav-links a.active {
        font-weight: bold;
        color: #000;
        border-bottom: 2px solid #000;
    }
    .top-nav-links a:hover {
        background-color: #f8f9fa;
    }

    .sidebar-property-list {
        min-height: 100vh;
        background: #fff;
        border-right: 1px solid #eee;
        padding: 0;
    }
    .property-list-item {
        transition: background 0.1s;
        cursor: pointer;
    }
    .property-list-item.active, .property-list-item:hover {
        background: #f5f5f5;
    }
    .property-list-item img {
        border-radius: 8px;
        border: 1px solid #eee;
    }

    /* Event pill style */
    .fc-timeline-event, .fc-event {
        background: #008489 !important;
        color: #fff !important;
        border-radius: 20px !important;
        font-size: 1em !important;
        font-weight: 500;
        padding: 6px 16px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        border: none !important;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .fc-timeline-event .fc-event-title, .fc-event .fc-event-title {
        color: #fff !important;
        font-weight: 600;
        font-size: 1em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Calendar grid improvements */
    .fc .fc-timeline-slot-label, .fc .fc-col-header-cell {
        font-weight: 700;
        color: #222;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        font-size: 1.1em;
        letter-spacing: 0.03em;
    }
    .fc .fc-timeline-slot {
        border-right: 1px solid #eee;
    }
    .fc .fc-resource-area-header {
        background: #f8f9fa;
        font-size: 1.1em;
        font-weight: 700;
    }

    /* Highlight today */
    .fc .fc-day-today {
        background: #e6f7f7 !important;
    }

    /* Hide FullCalendar's built-in resource area and header */
    .fc .fc-resource-area, .fc .fc-resource-area-header, .fc .fc-col-header-cell.fc-resource-area-header, .fc .fc-resource-timeline-divider, .fc .fc-resource-timeline-divider, .fc .fc-resource-area-header-cell, .fc .fc-resource-area-cushion, .fc .fc-resource-area .fc-datagrid-cell-main, .fc .fc-resource-area .fc-datagrid-cell {
        display: none !important;
    }
    .fc .fc-timeline-header {
        display: none !important;
    }
    .fc .fc-resource-timeline-divider {
        display: none !important;
    }
    .fc .fc-timeline-header-row-0 {
        display: none !important;
    }
    .fc .fc-resource-area {
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        padding: 0 !important;
    }
    .fc .fc-timeline-lane-frame {
        border-left: none !important;
    }
</style>
{% endblock %}

{% block content %}
{# Simple top navigation bar like the image #}
<nav class="top-nav">
    <div class="top-nav-brand">Abnb</div> {# Placeholder brand name #}
    <div class="top-nav-links">
        <a href="#">Today</a>
        <a href="#" class="active">Calendar</a>
        <a href="#">Listings</a>
        <a href="#">Messages</a>
        {# Add more links as needed #}
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar: Property List -->
        <div class="col-md-3 col-lg-2 d-none d-md-block sidebar-property-list" style="background:#fff; border-right:1px solid #eee; min-height:700px; padding:0;">
            <div class="p-3 border-bottom">
                <input type="text" class="form-control" id="propertySearch" placeholder="Search listings...">
            </div>
            <div id="propertyList" class="list-group list-group-flush">
                {% for resource in resources %}
                <a href="#" class="list-group-item list-group-item-action d-flex align-items-center property-list-item" data-resource-id="{{ resource.id }}">
                    <img src="{{ resource.image_url }}" alt="{{ resource.title }}" class="rounded me-2" style="width:40px; height:40px; object-fit:cover;">
                    <div>
                        <div class="fw-bold">{{ resource.title }}</div>
                        <div class="text-muted small">{{ resource.city }}, {{ resource.state }}</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        <!-- Main Calendar Area -->
        <div class="col-md-9 col-lg-10">
            <div class="calendar-container">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal (Optional - keep if needed, simplify if not) -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Booking Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Property:</strong> <span id="modalPropertyName"></span></p>
                <p><strong>Guest/Summary:</strong> <span id="modalTitle"></span></p>
                <p><strong>Dates:</strong> <span id="modalDates"></span></p>
                <p><strong>Source:</strong> <span id="modalSource"></span></p>
                <div id="modalActions" class="mt-3"></div>
                <!-- Add more details if needed -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
{# Include FullCalendar v5 with scheduler #}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.3/main.min.js"></script>
{# Include Bootstrap JS for modal #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    // Add debug logging for incoming data
    console.log('Resources:', {{ resources|tojson|safe }});
    console.log('Events:', {{ events|tojson|safe }});
    
    try {
        var resources = {{ resources|tojson|safe }};
        var events = {{ events|tojson|safe }};
        
        // --- Deduplicate events by external_id or id ---
        var seen = new Set();
        var dedupedEvents = [];
        for (var i = 0; i < events.length; i++) {
            var ev = events[i];
            var key = ev.external_id || ev.id;
            if (!seen.has(key)) {
                dedupedEvents.push(ev);
                seen.add(key);
            }
        }
        events = dedupedEvents;
        
        // --- Input Validation ---
        if (!calendarEl) {
            throw new Error("Calendar container element '#calendar' not found.");
        }
        if (!Array.isArray(resources)) {
            console.warn("Resources data is not a valid array:", resources);
            resources = [];
        }
        if (!Array.isArray(events)) {
            console.warn("Events data is not a valid array:", events);
            events = [];
        }

        // --- Calendar Initialization ---
        var calendarOptions = {
            schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
            initialView: 'timelineMonth',
            views: {
                timelineMonth: {
                    type: 'timeline',
                    duration: { months: 1 }
                },
                timelineWeek: {
                    type: 'timeline',
                    duration: { weeks: 1 }
                },
                timelineDay: {
                    type: 'timeline',
                    duration: { days: 1 }
                }
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timelineMonth,timelineWeek,timelineDay'
            },
            editable: false,
            selectable: true,
            timeZone: 'local',
            aspectRatio: 1.8,
            height: 'auto',
            events: events,
            slotMinWidth: 50,
            eventContent: function(arg) {
                // Show guest name, price, and status in a pill
                var guest = arg.event.extendedProps && arg.event.extendedProps.guest_name ? arg.event.extendedProps.guest_name : '';
                var price = arg.event.extendedProps && arg.event.extendedProps.amount ? ' $' + arg.event.extendedProps.amount : '';
                var status = arg.event.extendedProps && arg.event.extendedProps.status ? arg.event.extendedProps.status : '';
                // Avoid double status if title is same as status
                var title = guest || arg.event.title || 'Reserved';
                var showStatus = status && status !== title ? " <span class='badge bg-light text-dark ms-1'>" + status + "</span>" : '';
                return { html: '<div class="fc-event-title">' + title + price + showStatus + '</div>' };
            },
            eventDidMount: function(info) {
                if (info.event.extendedProps && info.event.extendedProps.guest_name && typeof bootstrap !== 'undefined') {
                    try {
                        var tooltipContent = `Guest: ${info.event.extendedProps.guest_name}<br>Source: ${info.event.extendedProps.service}`;
                        if (info.el) {
                            new bootstrap.Tooltip(info.el, {
                                title: tooltipContent,
                                html: true,
                                placement: 'top',
                                trigger: 'hover',
                                container: 'body'
                            });
                        }
                    } catch (e) {
                        console.warn("Tooltip initialization error:", e);
                    }
                }
            },
            eventClick: function(info) {
                try {
                    var event = info.event;
                    var props = event.extendedProps || {};
                    
                    var startDateStr = event.start ? event.start.toLocaleDateString() : 'N/A';
                    var endDateStr = 'N/A';
                    if (event.end) {
                        var endDate = new Date(event.end);
                        endDate.setDate(endDate.getDate() - 1);
                        endDateStr = endDate.toLocaleDateString();
                    }
                    
                    document.getElementById('modalPropertyName').textContent = props.property_name || 'N/A';
                    document.getElementById('modalTitle').textContent = event.title || 'N/A';
                    document.getElementById('modalDates').textContent = startDateStr + ' - ' + endDateStr;
                    document.getElementById('modalSource').textContent = props.service || 'N/A';

                    // Add action buttons
                    var actionsDiv = document.getElementById('modalActions');
                    if (actionsDiv) {
                        var assignTaskUrl = `/tasks/assign?property_id=${props.property_id || ''}&booking_id=${props.id || ''}`;
                        var repairRequestUrl = `/tasks/repair_requests/create?property_id=${props.property_id || ''}&booking_id=${props.id || ''}`;
                        actionsDiv.innerHTML = `
                            <a href="${assignTaskUrl}" class="btn btn-outline-primary me-2">Assign Task</a>
                            <a href="${repairRequestUrl}" class="btn btn-outline-danger">Create Repair Request</a>
                        `;
                    }

                    var eventModalElement = document.getElementById('eventModal');
                    if (eventModalElement) {
                        var eventModal = new bootstrap.Modal(eventModalElement);
                        eventModal.show();
                    } else {
                        console.error("Event modal element not found");
                    }
                } catch (e) {
                    console.error("Error showing event details:", e);
                }
                
                info.jsEvent.preventDefault();
            },
            select: function(info) {
                console.log('Selected ' + info.startStr + ' to ' + info.endStr + ' on resource ' + (info.resource ? info.resource.id : ''));
            }
        };

        var calendar = new FullCalendar.Calendar(calendarEl, calendarOptions);
        calendar.render();
        console.log('Calendar successfully rendered');
        
    } catch (error) {
        console.error("Error initializing FullCalendar:", error);
        if (calendarEl) {
            calendarEl.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Calendar Loading Error</h4>
                    <p>Could not load the calendar. Error details have been logged to the console.</p>
                    <p><small>Error: ${error.message}</small></p>
                </div>`;
        }
    }
});
</script>
{% endblock %}